# Magic Wand - æ‰‹åŠ¿è¯†åˆ«ç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

ä¸€ä¸ªåœ¨ Arduino Nano 33 BLE Sense ä¸Šè¿è¡Œçš„å®Œæ•´æ‰‹åŠ¿è¯†åˆ«ç³»ç»Ÿï¼Œç»“åˆäº†ï¼š
- **CNNéª¨å¹²ç½‘ç»œ** (TensorFlow Lite Micro)ï¼šä»IMUä¼ æ„Ÿå™¨æ•°æ®ä¸­æå–64ç»´ç‰¹å¾
- **è½»é‡çº§åˆ†ç±»å¤´**ï¼šè‡ªå®šä¹‰ç¥ç»ç½‘ç»œ (64â†’20â†’3) ç”¨äºæ‰‹åŠ¿åˆ†ç±»

## æ¼”ç¤ºè§†é¢‘
ğŸ“º YouTube æ¼”ç¤ºï¼š [ç‚¹å‡»è§‚çœ‹](https://youtu.be/VZNKlO5pTbw?si=IQ26gTzgAoTkZJx2)  
ğŸ¥ ä»“åº“æœ¬åœ°è§†é¢‘ï¼š [demo.mp4](demo.mp4)

## ä¸»è¦ç‰¹æ€§

- âœ… ä½¿ç”¨IMUä¼ æ„Ÿå™¨å®æ—¶è¯†åˆ«æ‰‹åŠ¿
- âœ… ä¸¤é˜¶æ®µæ¨ç†æµç¨‹ (CNN + åˆ†ç±»å¤´)
- âœ… æ­£ç¡®çš„æ•°æ®ç±»å‹å¯¹é½ (int8 â†’ float è½¬æ¢)
- âœ… æ”¯æŒBLEé€šä¿¡
- âœ… é’ˆå¯¹åµŒå…¥å¼è®¾å¤‡ä¼˜åŒ– (~150KB Flash, ~35KB SRAM)

## å¿«é€Ÿå¼€å§‹

### ç¡¬ä»¶è¦æ±‚
- Arduino Nano 33 BLE Sense
- USBæ•°æ®çº¿

### è½¯ä»¶è¦æ±‚
- Arduino IDE 1.8.x+
- åº“æ–‡ä»¶ï¼š
  - Arduino_TensorFlowLite
  - Arduino_LSM9DS1
  - ArduinoBLE

### å®‰è£…æ­¥éª¤

1. **å®‰è£…åº“æ–‡ä»¶**
   ```
   Tools â†’ Manage Libraries
   - æœç´¢å¹¶å®‰è£… "Arduino_TensorFlowLite"
   - æœç´¢å¹¶å®‰è£… "Arduino_LSM9DS1"
   - æœç´¢å¹¶å®‰è£… "ArduinoBLE"
   ```

2. **ä¸Šä¼ ä»£ç **
   ```
   - æ‰“å¼€ magic-wand-fl.ino
   - é€‰æ‹©å¼€å‘æ¿ï¼šTools â†’ Board â†’ Arduino Nano 33 BLE
   - é€‰æ‹©ç«¯å£ï¼šTools â†’ Port â†’ (ä½ çš„ç«¯å£)
   - ä¸Šä¼ ï¼šSketch â†’ Upload
   ```

3. **æµ‹è¯•**
   ```
   - æ‰“å¼€ä¸²å£ç›‘è§†å™¨ (96000æ³¢ç‰¹ç‡)
   - åœ¨ç©ºä¸­æ‰§è¡Œæ‰‹åŠ¿
   - æŸ¥çœ‹è¯†åˆ«ç»“æœ
   ```

## ç³»ç»Ÿæ¶æ„

```
ä¼ æ„Ÿå™¨æ•°æ® â†’ ç¬”ç”»è¿½è¸ª â†’ æ …æ ¼åŒ– (32Ã—32Ã—3)
     â†“
CNNéª¨å¹²ç½‘ç»œ (TFLite)
     â†“
64ç»´ int8 ç‰¹å¾
     â†“
ç±»å‹è½¬æ¢ (int8 â†’ float) + å½’ä¸€åŒ– [0,1]
     â†“
åˆ†ç±»å¤´ (64â†’20â†’3)
     â†“
3ä¸ªç±»åˆ«æ¦‚ç‡
```

## é¡¹ç›®ç»“æ„

```
magic-wand-fl/
â”œâ”€â”€ magic-wand-fl.ino              # ä¸»ç¨‹åºï¼ˆå·²é›†æˆï¼‰
â”œâ”€â”€ magic_wand_model_data.cpp/h    # CNNæ¨¡å‹æƒé‡
â”œâ”€â”€ rasterize_stroke.cpp/h         # ç¬”ç”»å¤„ç†
â””â”€â”€ FL/FL_Central/
    â”œâ”€â”€ Inference_Lite.h           # åˆ†ç±»å¤´æ¨ç†å¼•æ“
    â””â”€â”€ TrainedModel.h             # è®­ç»ƒæƒé‡
```

## æ ¸å¿ƒå®ç°

### æ•°æ®ç±»å‹è½¬æ¢ (ConvertInt8ToFloat)

**åŠŸèƒ½**: å°† CNN çš„ int8 è¾“å‡ºè½¬æ¢ä¸ºåˆ†ç±»å¤´éœ€è¦çš„ float[0,1] è¾“å…¥

**æ–¹æ³•**: Min-Max å½’ä¸€åŒ–

```cpp
// CNNè¾“å‡ºint8é‡åŒ–å€¼
// åˆ†ç±»å¤´æœŸæœ›[0,1]èŒƒå›´çš„floatå€¼
1. åé‡åŒ–: real = (int8 - zero_point) Ã— scale
2. æ‰¾åˆ° min å’Œ max
3. å½’ä¸€åŒ–: normalized = (real - min) / (max - min)
```

### ç½‘ç»œé…ç½®

åœ¨ `magic-wand-fl.ino` ä¸­ä¿®æ”¹ï¼š

```cpp
// ç±»åˆ«æ•°é‡
constexpr int label_count = 3;

// ç±»åˆ«æ ‡ç­¾
const char* labels[label_count] = {"ç±»åˆ«0", "ç±»åˆ«1", "ç±»åˆ«2"};

// ç½‘ç»œç»“æ„ï¼šè¾“å…¥å±‚ â†’ éšè—å±‚ â†’ è¾“å‡ºå±‚
const unsigned int NN_DEF[] = {64, 20, 3};
```

## æ€§èƒ½æŒ‡æ ‡

- **æ¨ç†æ—¶é—´**ï¼šæ¯ä¸ªæ‰‹åŠ¿çº¦200ms
  - CNNï¼šçº¦100-200ms
  - åˆ†ç±»å¤´ï¼šçº¦5-10ms
  - æ•°æ®è½¬æ¢ï¼š<1ms
- **å†…å­˜ä½¿ç”¨**ï¼š
  - Flashï¼šçº¦150KB
  - SRAMï¼šçº¦35KB
- **å‡†ç¡®ç‡**ï¼š94%ï¼ˆåœ¨åˆ†ç±»å¤´ä¸Šæµ‹è¯•é›†ï¼‰

## æ•…éšœæ’é™¤

### ç¼–è¯‘é”™è¯¯

**é”™è¯¯ï¼š`Library Version Mismatch`**
- è§£å†³ï¼šç§»é™¤ `Harvard_TinyMLx` åº“ï¼Œåªä¿ç•™ `Arduino_TensorFlowLite`


### è¿è¡Œæ—¶é—®é¢˜

**æ— ä¸²å£è¾“å‡º**
- æ£€æŸ¥æ³¢ç‰¹ç‡æ˜¯å¦è®¾ç½®ä¸º 96000
- éªŒè¯ç«¯å£é€‰æ‹©æ˜¯å¦æ­£ç¡®

**è¯†åˆ«å‡†ç¡®ç‡ä½**
- ç¡®ä¿æ‰‹åŠ¿æ‰§è¡Œæ¸…æ™°
- æ£€æŸ¥ç‰¹å¾å€¼æ˜¯å¦åœ¨ [0, 1] èŒƒå›´å†…
- å¦‚éœ€è¦å¯é‡æ–°è®­ç»ƒåˆ†ç±»å¤´


## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµéªŒè¯

| é˜¶æ®µ | ç±»å‹ | ç»´åº¦ | èŒƒå›´ |
|-----|------|------|------|
| CNNè¾“å‡º | int8 | 64 | [-128, 127] |
| åé‡åŒ–å | float | 64 | ~[-1, 1] |
| å½’ä¸€åŒ–å | float | 64 | [0, 1] |
| åˆ†ç±»å¤´è¾“å…¥ | float | 64 | [0, 1] |
| åˆ†ç±»å¤´è¾“å‡º | float | 3 | [0, 1] |

### å†…å­˜åˆ†é…

**Flashï¼ˆç¨‹åºå­˜å‚¨ï¼‰**
- TFLiteæ¨¡å‹ï¼šçº¦80KB
- TFLiteåº“ï¼šçº¦40KB
- åº”ç”¨ä»£ç ï¼šçº¦30KB

**SRAMï¼ˆè¿è¡Œæ—¶ï¼‰**
- CNN Tensor Arenaï¼š30KB
- åˆ†ç±»å¤´ï¼šçº¦5KB
- ç‰¹å¾ç¼“å†²ï¼š256å­—èŠ‚




